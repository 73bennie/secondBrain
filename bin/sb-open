#!/usr/bin/env bash
set -euo pipefail

COMMON="$HOME/.secondbrain/lib/sb-common.sh"
[[ -f "$COMMON" ]] && source "$COMMON"

DB="${SB_DB:-$HOME/.secondbrain/brain.db}"

if [[ $# -ne 2 ]]; then
  echo "Usage: sb-open <admin|projects|people|ideas|inbox> <id>"
  exit 1
fi

etype="$1"
eid="$2"

if ! [[ "$eid" =~ ^[0-9]+$ ]]; then
  echo "id must be a number"
  exit 1
fi

case "$etype" in
  admin|projects|people|ideas|inbox) ;;
  *) echo "bad type: $etype"; exit 1 ;;
esac

# Vault-first path selection (Mode A)
vault_mode=0
if [[ -n "${SB_VAULT:-}" && -n "${SB_VAULT_DIR:-}" ]] && command -v sb_vault_note_path >/dev/null 2>&1; then
  vault_mode=1
  file="$(sb_vault_note_path "$etype" "$eid")"
  dir="$(dirname "$file")"
  mkdir -p "$dir"
else
  # Legacy workdir behavior
  dir="$HOME/.secondbrain/work/$etype/$eid"
  mkdir -p "$dir"
  file="$dir/notes.md"
fi

if [[ ! -f "$file" ]]; then
  printf '# %s %s\n\n' "$etype" "$eid" > "$file"
fi

# record as attachment (idempotency not enforced; fine for now)
#sqlite3 "$DB" "INSERT INTO attachments (entity_type, entity_id, path, label) VALUES ('$etype',$eid,'$file','notes');" >/dev/null 2>&1 || true
# Record attachment (vault vs legacy)
label="notes"
if [[ "$vault_mode" -eq 1 ]]; then
  label="vault_notes"
fi

# Escape single-quotes for SQLite
file_esc="${file//\'/\'\'}"
label_esc="${label//\'/\'\'}"

#Idempotent attachments:
# - Always keep exactly one row for the chosen label
# - In vault mode, also remove legacy 'notes' attachments for this entity
sqlite3 "$DB" "
  DELETE FROM attachments
   WHERE entity_type='$etype'
     AND entity_id=$eid
     AND label='$label_esc';

  DELETE FROM attachments
   WHERE entity_type='$etype'
     AND entity_id=$eid
     AND label='notes'
     AND '$label_esc'='vault_notes';

  INSERT INTO attachments (entity_type, entity_id, path, label)
  VALUES ('$etype', $eid, '$file_esc', '$label_esc');
" >/dev/null 2>&1 || true

exec vim "$file"
