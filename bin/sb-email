#!/usr/bin/env bash
set -euo pipefail
DB="${SB_DB:-$HOME/.secondbrain/brain.db}"

if [[ $# -ne 2 ]]; then
  echo "Usage: sb-email <admin|projects> <id>"
  exit 1
fi

etype="$1"
eid="$2"

if ! [[ "$eid" =~ ^[0-9]+$ ]]; then
  echo "id must be a number"
  exit 1
fi

case "$etype" in
  admin|projects) ;;
  *) echo "Use admin or projects for email drafts"; exit 1 ;;
esac

dir="$HOME/.secondbrain/work/$etype/$eid"
mkdir -p "$dir"
file="$dir/email.md"

if [[ ! -f "$file" ]]; then
  subject=$(sqlite3 "$DB" "SELECT CASE '$etype' WHEN 'admin' THEN task WHEN 'projects' THEN name END FROM $etype WHERE id=$eid;")
  {
    echo "To: "
    echo "Subject: ${subject:-}"
    echo
    echo "Hi ,"
    echo
    echo
    echo "- Bennie"
  } > "$file"
fi

sqlite3 "$DB" "INSERT INTO attachments (entity_type, entity_id, path, label) VALUES ('$etype',$eid,'$file','email');" >/dev/null 2>&1 || true

exec vim "$file"
